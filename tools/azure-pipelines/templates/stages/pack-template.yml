parameters:
  - name: vmImage
    type: string
  - name: dotNetVersion
    type: string
  - name: buildConfiguration
    type: string
  - name: buildPlatform
    type: string
  - name: buildProjects
    type: string
  - name: packages
    type: object

stages:
  - stage: Pack
    displayName: Pack
    jobs:
      - job: Pack
        pool:
          vmImage: ${{ parameters.vmImage }}
        steps:
          - task: VersionDotNetCoreAssemblies@3
            displayName: "Set FileVersion on *.csproj $(Build.BuildNumber)"
            inputs:
              Path: "$(Build.SourcesDirectory)"
              VersionNumber: "$(Build.BuildNumber)"
              Injectversion: False
              VersionRegex: '\d+\.\d+\.\d+\.\d+'
              FilenamePattern: ".csproj"
              AddDefault: true
              OutputVersion: "OutputedVersion"

          - template: ../steps/build-template.yml
            parameters:
              dotNetVersion: ${{ parameters.dotNetVersion }}
              buildConfiguration: ${{ parameters.buildConfiguration }}
              buildPlatform: ${{ parameters.buildPlatform }}
              buildProjects: ${{ parameters.buildProjects }}

          - template: ../steps/pack-template.yml
            parameters:
              packages: ${{ parameters.packages }}

          - task: PublishBuildArtifacts@1
            displayName: Publish
            inputs:
              pathtoPublish: $(build.artifactStagingDirectory)

  # - task: DotNetCoreCLI@2
  #   displayName: "dotnet push"
  #   condition: eq(variables['PACK_RUN'], 'true')
  #   inputs:
  #     command: "push"
  #     packagesToPush: "$(Build.ArtifactStagingDirectory)/*.nupkg"
  #     nuGetFeedType: "internal"
  #     publishVstsFeed: "9c9efb62-bded-45a2-b46b-0511633df679/c81626eb-ca9d-4a1c-8591-72ddfa135a6c"
